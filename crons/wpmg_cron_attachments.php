<?php defined('ABSPATH') or die("Cannot access pages directly.");/* * Description: cron to parse emails to db from various groups * Created: 8/2013 * Author: axactsoft.com * Website: http://www.wpmailinggroup.com */function wpmg_auto_delete_attachments() {global $wpdb, $objMem, $obj, $table_name_group, $table_name_message, $table_name_requestmanager, $table_name_requestmanager_taxonomy, $table_name_user_taxonomy, $table_name_parsed_emails, $table_name_sent_emails, $table_name_crons_run, $table_name_attachments, $table_name_users, $table_name_usermeta; require_once(WPMG_PLUGIN_PATH.'/lib/mailinggroupclass.php');$objMem = new mailinggroupClass();/* get all groups one by one */$groupresult = $objMem->selectRows($table_name_group, "",  " where status = '1' order by id desc");if(count($groupresult)>0) {	foreach($groupresult as $row) {		$id = $row->id;		$save_attachments      = $row->save_attachments;	$att_auto_delete       = $row->att_auto_delete;	$att_auto_delete_limit = $row->att_auto_delete_limit;	$size_limit            = $row->size_limit;	$size_limit_value      = $row->size_limit_value ;	$upload_dir   = wp_upload_dir();	$user_dirname = $upload_dir['basedir'].'/mg_groups/'.$id;	$user_urlname = $upload_dir['baseurl'].'/mg_groups/'.$id;	    	if(isset($save_attachments) && $save_attachments == '1'){		$get_size  = $objMem->selectRows($table_name_attachments, "", " ORDER BY id ASC");			if(!empty($get_size)){		foreach($get_size as $key=>$value){		    $aid=$value->id;			if(isset($att_auto_delete) && $att_auto_delete=='1'){				if(isset($att_auto_delete_limit) && $att_auto_delete_limit > 0){							    $size += $value->size; 				$cdate = $value->date;				$pdate = date("m/d/Y");					$date1 = date_create($cdate);				$date2 = date_create($pdate);				$diff=date_diff($date1,$date2);					$traildays = $diff->days;				                if($traildays>$att_auto_delete_limit){									$fields = array("id","attachments");					$grpinfo['id'] = $value->email_id;					$grpinfo['attachments'] = "0";					$objMem->updRow($table_name_parsed_emails,$grpinfo,$fields);				    $wpdb->query("DELETE FROM " . $table_name_attachments . " WHERE id=$aid");					$files = unserialize($value->file_name);					foreach($files as $ak=>$av){						$filename=$user_dirname."/".$av[0];						@unlink($filename);					}			    }	 				}			}			if(isset($size_limit) && $size_limit=='1'){				if(isset($size_limit_value) && $size_limit_value > 0){				$size1 += $value->size;				$size = round(($size1/1024)/1024); 				                if($size>$size_limit_value){					$fields = array("id","attachments");					$grpinfo['id'] = $value->email_id;					$grpinfo['attachments'] = "0";					$objMem->updRow($table_name_parsed_emails,$grpinfo,$fields);									$wpdb->query("DELETE FROM " . $table_name_attachments . " WHERE id=$aid");					$files = unserialize($value->file_name);					foreach($files as $ak=>$av){						$filename=$user_dirname."/".$av[0];						@unlink($filename);					}			    }                unset($size);								}			}					}				}	}}}}